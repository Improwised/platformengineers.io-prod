<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head >
    <title>Secrets Management in CD Environments with GitOps and SOPS | Platform Engineers</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" http-equiv="Content-Language" content="en"><meta data-n-head="ssr" name="viewport" content="width=device-width, initial-scale=1"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><meta data-n-head="ssr" name="author" content="Platform Engineers"><meta data-n-head="ssr" name="copyright" content="Platform Engineers"><meta data-n-head="ssr" name="robots" content="index, follow"><meta data-n-head="ssr" name="theme-color" content="#179bfd"><meta data-n-head="ssr" name="application-name" content="Platform Engineers"><meta data-n-head="ssr" name="msapplication-TileColor" content="#FFFFFF"><meta data-n-head="ssr" name="msapplication-TileImage" content="/img/favicon/ms-icon-144x144.png"><meta data-n-head="ssr" name="msapplication-square70x70logo" content="/img/favicon/ms-icon-70x70.png"><meta data-n-head="ssr" name="msapplication-square144x144logo" content="/img/favicon/ms-icon-144x144.png"><meta data-n-head="ssr" name="msapplication-square150x150logo" content="/img/favicon/ms-icon-150x150.png"><meta data-n-head="ssr" name="msapplication-square310x310logo" content="/img/favicon/ms-icon-310x310.png"><meta data-n-head="ssr" name="description" content="Secrets Management in CD Environments with GitOps and SOPS | Platform Engineers"><meta data-n-head="ssr" name="title" content="Secrets Management in CD Environments with GitOps and SOPS | Platform Engineers"><meta data-n-head="ssr" property="og:type" content="website"><meta data-n-head="ssr" property="og:url" content="https://platformengineers.io/blog/secrets-management-with-gitops-and-sops/"><meta data-n-head="ssr" property="og:title" content="Secrets Management in CD Environments with GitOps and SOPS | Platform Engineers"><meta data-n-head="ssr" property="og:description" content="Secrets Management in CD Environments with GitOps and SOPS | Platform Engineers"><meta data-n-head="ssr" property="og:image" content="https://platformengineers.io/_nuxt/image/9296c2.png"><meta data-n-head="ssr" property="twitter:card" content="summary"><meta data-n-head="ssr" property="twitter:site" content=""><meta data-n-head="ssr" property="twitter:creator" content=""><meta data-n-head="ssr" property="twitter:title" content="Secrets Management in CD Environments with GitOps and SOPS | Platform Engineers"><meta data-n-head="ssr" property="twitter:description" content="Secrets Management in CD Environments with GitOps and SOPS | Platform Engineers"><meta data-n-head="ssr" property="twitter:image" content="https://platformengineers.io/_nuxt/image/9296c2.png"><link data-n-head="ssr" href="https://fonts.googleapis.com" rel="preconnect"><link data-n-head="ssr" href="https://maps.googleapis.com" rel="preconnect"><link data-n-head="ssr" href="https://www.gstatic.com" rel="preconnect"><link data-n-head="ssr" rel="apple-touch-icon" sizes="57x57" href="/img/favicon/apple-icon-57x57.png"><link data-n-head="ssr" rel="apple-touch-icon" sizes="60x60" href="/img/favicon/apple-icon-60x60.png"><link data-n-head="ssr" rel="apple-touch-icon" sizes="72x72" href="/img/favicon/apple-icon-72x72.png"><link data-n-head="ssr" rel="apple-touch-icon" sizes="76x76" href="/img/favicon/apple-icon-76x76.png"><link data-n-head="ssr" rel="apple-touch-icon" sizes="114x114" href="/img/favicon/apple-icon-114x114.png"><link data-n-head="ssr" rel="apple-touch-icon" sizes="120x120" href="/img/favicon/apple-icon-120x120.png"><link data-n-head="ssr" rel="apple-touch-icon" sizes="144x144" href="/img/favicon/apple-icon-144x144.png"><link data-n-head="ssr" rel="apple-touch-icon" sizes="152x152" href="/img/favicon/apple-icon-152x152.png"><link data-n-head="ssr" rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-icon-180x180.png"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/img/favicon/favicon.ico"><link data-n-head="ssr" rel="icon" type="image/png" href="/img/favicon/favicon-16x16.png" sizes="16x16"><link data-n-head="ssr" rel="icon" type="image/png" href="/img/favicon/favicon-32x32.png" sizes="32x32"><link data-n-head="ssr" rel="icon" type="image/png" href="/img/favicon/favicon-96x96.png" sizes="96x96"><link data-n-head="ssr" rel="manifest" href="/manifest.json"><link data-n-head="ssr" rel="canonical" href="https://platformengineers.io/blog/secrets-management-with-gitops-and-sops/"><link data-n-head="ssr" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/monokai-sublime.min.css"><script data-n-head="ssr" type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"Platform Engineers","alternateName":"Platform Engineers","url":"https://platformengineers.io/","image":"https://platformengineers.io/img/plateform-engineers.png","sameAs":[]}</script><link rel="preload" href="/_nuxt/23217b8.js" as="script"><link rel="preload" href="/_nuxt/0f88427.js" as="script"><link rel="preload" href="/_nuxt/css/64240c5.css" as="style"><link rel="preload" href="/_nuxt/990548d.js" as="script"><link rel="preload" href="/_nuxt/b4cbe7a.js" as="script"><link rel="preload" href="/_nuxt/css/998d57e.css" as="style"><link rel="preload" href="/_nuxt/1d8d9a4.js" as="script"><link rel="preload" href="/_nuxt/css/01649ec.css" as="style"><link rel="preload" href="/_nuxt/accecf1.js" as="script"><link rel="stylesheet" href="/_nuxt/css/64240c5.css"><link rel="stylesheet" href="/_nuxt/css/998d57e.css"><link rel="stylesheet" href="/_nuxt/css/01649ec.css"><link rel="preload" href="/_nuxt/static/1737013687/blog/secrets-management-with-gitops-and-sops/state.js" as="script"><link rel="preload" href="/_nuxt/static/1737013687/blog/secrets-management-with-gitops-and-sops/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1737013687/manifest.js" as="script">
  </head>
  <body >
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><div><link rel="stylesheet" type="text/css" href="/dist/main.min.css" media="all"> <link rel="stylesheet" type="text/css" href="/dist/fontsicon.min.css"></div> <a id="start" rel="nofollow" aria-label="start point of page" href="javscript:void(0);"></a> <div class="main-container blog"><div class="blog-bk"><div class="nav-container"><div class="bar bar--sm visible-xs"><div class="container"><div class="row align-items-center"><div class="col-3 col-md-2"><a href="/"><img src="/_nuxt/image/e7b705.png" alt="Platform Engineers" loading="lazy" title="Platform Engineers"></a></div> <div class="col-9 col-md-10 text-right"><a href="#" aria-label="toggle" data-toggle-class="#menu1;hidden-xs" class="hamburger-toggle"><i class="icon icon--sm stack-interface stack-menu"></i></a></div></div></div></div> <nav id="menu1" data-scroll-class="366px:pos-fixed" class="bar bar--sm bar-1 hidden-xs"><div class="container"><div class="row align-items-center"><div class="hidden-xs d-flex align-items-center"><div class="bar__module"><a href="/"><img src="/_nuxt/image/418082.png" width="68" height="55" alt="Platform Engineers" loading="lazy" title="Platform Engineers"></a></div></div> <div class="col text-right text-left-xs text-left-sm"><div class="bar__module"><ul class="menu-horizontal text-left"><li><a href="/">Home</a></li> <li><a href="/about-us/">About Us</a></li> <li class="dropdown"><span class="dropdown__trigger">Services</span> <div class="dropdown__container"><div class="container"><div class="row"><div class="mt-1 dropdown__content col-lg-3 col-md-4 col-sm-6 p-3"><ul class="menu-vertical"><li><a href="/assessment/">Cost Assessment</a></li> <li><a href="/assessment/">Performance Assessment</a></li> <li><a href="/services/platform-engineering/">Platform Engineering</a></li><li><a href="/services/kubernetes-consulting-services/">Kubernetes Consulting Services</a></li><li><a href="/services/containerization/">Containerization</a></li><li><a href="/services/performance-optimization/">Performance Optimization</a></li><li><a href="/services/ci-cd-implementation/">CI/CD Implementation</a></li><li><a href="/services/infrastructure-maintenance-and-support/">Infra Maintenance &amp; Support</a></li></ul></div></div></div></div></li> <li class="dropdown"><span class="dropdown__trigger">Industries</span> <div class="dropdown__container"><div class="container"><div class="row"><div class="mt-1 dropdown__content col-lg-3 col-md-4 col-sm-6 p-3"><ul class="menu-vertical"><li><a href="/industries/IoT/">IoT</a></li><li><a href="/industries/ecommerce/">eCommerce</a></li><li><a href="/industries/fintech/">FinTech</a></li><li><a href="/industries/SaaS/">SaaS</a></li><li><a href="/industries/enterprise/">Enterprise</a></li></ul></div></div></div></div></li> <li><a href="/blog/">Blog</a></li> <li><a href="/case-studies/">Case Studies</a></li></ul></div> <div class="bar__module"><div><a href="/contact-us/" title="contact" class="btn btn--primary type--uppercase b-30"><span class="btn__text"> Contact us </span></a></div></div></div></div></div></nav></div> <div class="container"><div class="row py-2"><div class="col-md-6 d-flex align-items-center justify-content-center"><div><h1 class="h2 mb-0">Secrets Management in CD Environments with GitOps and SOPS</h1> <div class="lh-1 mb-3">
          Tue, 23/07/2024 |
          5 mins
        </div> <!----> <!----> <div class="row"><div class="col-lg-4 col-md-12"><div class="d-flex align-items-center mt-3"><div class="d-flex align-items-center mr-2" style="border-radius: 200px"><img src="/_nuxt/image/a07868.png" width="32" height="40" alt="Secrets Management in CD Environments with GitOps and SOPS" title="Secrets Management in CD Environments with GitOps and SOPS" class="p-0 m-0 rounded author-s"></div> <div><strong class="m-0 p-0 lh-1">
                  Angita
                  Shah
                </strong></div></div></div><div class="col-lg-4 col-md-12"><div class="d-flex align-items-center mt-3"><div class="d-flex align-items-center mr-2" style="border-radius: 200px"><img src="/_nuxt/image/32d461.png" width="32" height="40" alt="Secrets Management in CD Environments with GitOps and SOPS" title="Secrets Management in CD Environments with GitOps and SOPS" class="p-0 m-0 rounded author-s"></div> <div><strong class="m-0 p-0 lh-1">
                  Satish
                  Annavar 
                </strong></div></div></div></div> <!----></div></div> <div class="col-md-6 d-flex align-items-center justify-content-center"><img src="/_nuxt/image/efa214.png" height="400" alt="Secrets Management in CD Environments with GitOps and SOPS | Platform Engineers" decoding="async" class="img-dim" style="color:transparent;"></div></div></div></div> <section class="bg-- wave-bk-1 section-padding"><div class="container"><div class="row"><div class="col-lg-10 offset-lg-1 bs-11 p-5 b-30 bg-white"><div class="fc-lead ul-list"><p dir="ltr">Modern software development practices heavily rely on continuous integration and continuous delivery (CI/CD) pipelines for automated deployments. These pipelines automate various tasks, including building, testing, and deploying applications. However, a critical challenge in CD environments is managing secrets securely. Secrets, such as API keys, passwords, and database credentials, are essential for application functionality, but their exposure can lead to security vulnerabilities.</p>
<p dir="ltr">SOPS is a text file editor that automates the encryption and decryption of files. It supports various encryption methods, including GPG, AWS KMS, GCP KMS, AGE and HashiCorp Vault. SOPS integrates with VSCode and other editors, allowing users to edit encrypted files seamlessly.</p>
<h2 dir="ltr">What is GitOps?</h2>
<p dir="ltr">GitOps is a DevOps practice that uses Git as the single source of truth for infrastructure and application configurations. It enables developers to manage infrastructure and applications using familiar tools and workflows. GitOps workflows typically involve using a CI/CD pipeline to automatically deploy changes to infrastructure and applications based on changes to Git repositories.</p>
<h2 dir="ltr">Approaches for secret Management</h2>
<p dir="ltr">When it comes to Continuous Deployment (CD), managing secrets securely is crucial. While GitOps and SOPS are popular approaches, there are other methods worth exploring. In this post, we'll discuss the importance of secrets management and alternative strategies using Vault and cloud providers. There are several approaches to secret management beyond HashiCorp Vault and cloud provider-specific solutions:</p>
<ul>
<li><strong>External Secrets Operator (ESO): </strong>This is an open-source Kubernetes operator that integrates with external secret stores like AWS Secrets Manager, Google Cloud Secret Manager, and Azure Key Vault. It provides a user-friendly abstraction for managing secrets across multiple environments.<br><br></li>
<li><strong>Hashicorp Vault: </strong>HashiCorp Vault is a comprehensive secret management solution that provides granular access controls, audit logs, and dynamic secret generation. It is widely used but can be complex to set up and maintain.<br><br></li>
<li><strong>In-house Tools: </strong>Some organizations develop their own in-house tools for managing secrets and configurations. These tools can be tailored to the specific needs of the organization and can integrate with various secret management solutions.</li>
</ul>
<p dir="ltr">We chose to use SOPS over other secret management options because of its unique approach to encryption and version control. Unlike other solutions that encrypt both the secret values and keys, SOPS only encrypts the values, leaving the keys in plain text. This allows us to track changes to secrets in our Git repository, ensuring that all environment files have the same keys.</p>
<p dir="ltr">This approach also simplifies the management of secrets across different environments, as the keys remain consistent. SOPS integrates seamlessly with our existing Git workflow, making it easy to adopt and maintain. By using SOPS, we can ensure the security of our secrets while also maintaining transparency and control over changes to those secrets.</p>
<h2 dir="ltr">What is SOPS?</h2>
<p dir="ltr">SOPS is an open-source tool that enables developers to encrypt secrets in Git repositories. It uses AWS KMS, GCP KMS, or Azure Key Vault to encrypt secrets and stores the encrypted secrets in Git. SOPS also enables developers to decrypt secrets using the same key management service.</p>
<p dir="ltr">Secrets management is crucial for ensuring the security and integrity of sensitive data and systems within an organization. Here are some key reasons why secrets are important and what can be done for effective secret management:</p>
<ul>
<li><strong>Preventing Data Breaches: </strong>Proper secrets management helps avoid costly data breaches by ensuring that sensitive information, such as passwords, keys, and tokens, are securely stored and transmitted. This minimizes the risk of unauthorized access to critical systems and data.<br><br></li>
<li><strong>Protecting Critical Assets:</strong> Secrets management safeguards critical assets, including user and application accounts, devices, and other network elements, from intrusions and unauthorized access.<br><br></li>
<li><strong>Compliance with Regulations:</strong> Effective secrets management helps organizations meet the requirements of security regulations and standards, such as NIST, FIPS, and HIPAA, by ensuring secure storage, transmission, and auditing of secrets.</li>
</ul>
<h3 dir="ltr">Why use SOPS with GitOps?</h3>
<p dir="ltr">Using SOPS with GitOps provides several benefits: SOPS encrypts secrets before they are committed to Git, ensuring that they are not stored in plaintext.&nbsp;Git provides version control for secrets, enabling developers to track changes and roll back to previous versions if necessary. SOPS enables developers to manage secrets using familiar Git workflows, reducing the complexity of secrets management.</p>
<h3 dir="ltr">How Does It Work?</h3>
<p dir="ltr">SOPS encrypts files automatically when they are written and decrypts them when they are read. It supports various encryption methods, making it highly customizable. SOPS can be used with text files or structured data such as YAML, JSON, INI, and ENV files.</p>
<h2 dir="ltr">How to use SOPS with GitOps</h2>
<p dir="ltr">To use SOPS with GitOps, we will use FluxCD's kustomize-controller. This controller decrypts secrets encrypted with SOPS using in-cluster secrets or cloud provider integrations, ensuring secure management within your GitOps workflow.</p>
<h3 dir="ltr"><strong>SOPS with AWS KMS</strong></h3>
<p dir="ltr"><strong>Step 1: Install SOPS</strong></p>
<p>1. Download SOPS:</p>
<pre><code>curl -LO https://github.com/getsops/sops/releases/download/v3.7.3/sops-v3.7.3.linux.amd64</code></pre>
<p dir="ltr" role="presentation">2. Copy the Downloaded file to local/bin:</p>
<pre><code>mv sops-v3.7.3.linux.amd64 /usr/local/bin/sops</code></pre>
<p dir="ltr" role="presentation">3. Make SOPS Executable:</p>
<pre><code>chmod +x /usr/local/bin/sops</code></pre>
<p dir="ltr"><strong>Step 2: Create a KMS Key</strong></p>
<p dir="ltr" role="presentation">1. Sign in to AWS Management Console:&nbsp;Open the AWS Management Console and navigate to the KMS console.</p>
<p>2. Create a KMS Key:</p>
<ul>
<li dir="ltr" aria-level="2">
<p dir="ltr" role="presentation">Choose "Create key".</p>
</li>
<li dir="ltr" aria-level="2">
<p dir="ltr" role="presentation">Enter an alias for the key (e.g., "sops-key").</p>
</li>
<li dir="ltr" aria-level="2">
<p dir="ltr" role="presentation">Choose "AWS KMS generates the key material".</p>
</li>
<li dir="ltr" aria-level="2">
<p dir="ltr" role="presentation">Add the AWS users or roles that will manage the key.</p>
</li>
<li dir="ltr" aria-level="2">
<p dir="ltr" role="presentation">Set the key usage permissions.</p>
</li>
<li dir="ltr" aria-level="2">
<p dir="ltr" role="presentation">Review and create the key.</p>
</li>
</ul>
<p dir="ltr"><strong>Step 3: Configure SOPS</strong></p>
<p dir="ltr">Create a Configuration File: Create a file <code>~/.sops.yaml</code> with the following content:<br>creation_rules:</p>
<pre><code>- kms: arn:aws:kms:{region}:{account-id}:alias/{alias}</code></pre>
<p dir="ltr">Replace <code>{region}</code>, <code>{account-id}</code>, and <code>{alias}</code> with your AWS region, account ID, and the alias of your KMS key.</p>
<p dir="ltr"><strong>Step 4: Encrypt Secrets</strong></p>
<p dir="ltr" role="presentation">1. Create a YAML File with Secrets: Create a file&nbsp;<code>secrets.yaml</code> containing your secrets.</p>
<p dir="ltr" role="presentation">2. Encrypt the File:</p>
<div dir="ltr" align="left">
<pre><code>sops --encrypt --kms arn:aws:kms:us-east-1:001301278159:key/b3f4dd5b-a217-46b5-aef2-152fa66be8f4 --encryption-context Role secrets.yaml</code></pre>
<p dir="ltr"><strong>Step 5: Configure FluxCD</strong></p>
<p>1. Create a Kubernetes Secret: Create a Kubernetes secret with the PGP keys on each cluster.</p>
<p dir="ltr" role="presentation">2. Add GitRepository and Kustomization Manifests: Add the GitRepository and Kustomization manifests to the fleet repository.</p>
<p dir="ltr" role="presentation">3. Configure Decryption: Configure the Kustomization manifest to use SOPS for decryption:</p>
<pre><code>apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
name: my-secrets
namespace: flux-system
spec:
interval: 10m0s
sourceRef:
  kind: GitRepository
  name: my-secrets
path: ./
prune: true
decryption:
  provider: sops
  secretRef:
    name: sops-gpg</code></pre>
<p><strong>&nbsp;Step 6: Deploy and Sync</strong></p>
<p dir="ltr" role="presentation">1. Commit and Push Changes: Commit the encrypted secrets and manifests to the Git repository.</p>
<p dir="ltr" role="presentation">2. Sync with FluxCD: FluxCD will pull the changes from the Git repository, decrypt the secrets using SOPS and AWS KMS, and apply them to the cluster.</p>
<p dir="ltr">By following these steps, you can securely manage and deploy Kubernetes secrets using SOPS and AWS KMS with FluxCD.</p>
<h3 dir="ltr"><strong>SOPS with AGE encryption</strong></h3>
<p dir="ltr"><strong>Step 1: Generate an AGE Key</strong></p>
<p dir="ltr">Generate an AGE key: Use the <code>age-keygen</code> command to create a key pair. This command generates a public and private key.</p>
<pre><code>age-keygen -o age.agekey</code></pre>
<p dir="ltr"><strong>Step 2: Configure SOPS</strong></p>
<p dir="ltr">Create .sops.yaml file: This file configures SOPS to use the AGE key for encryption and decryption.</p>
<pre><code>creation_rules:
- encrypted_regex: '^(data|stringData)$'
  age: < public_key ></code></pre>
<p dir="ltr"><strong>Step 3: Encrypt Secrets</strong></p>
<p dir="ltr">Encrypt a Kubernetes secret: Use SOPS with the AGE public key to encrypt a secret.</p>
<pre><code>sops --age=< public_key > --encrypt --encrypted-regex '^(data|stringData)$' --in-place basic-auth.yaml</code></pre>
<p dir="ltr"><strong>Step 4: Create a Secret in Kubernetes</strong></p>
<p dir="ltr">Create a secret in Kubernetes: Use the AGE private key to create a secret in the <code>flux-system</code> namespace.</p>
<pre><code>cat age.agekey | kubectl create secret generic sops-age --namespace=flux-system --from-file=age.agekey=/dev/stdin</code></pre>
<p dir="ltr"><strong>Step 5: Configure Flux</strong></p>
<p dir="ltr">Update the Flux Kustomization: Add the decryption configuration to the Flux Kustomization.</p>
<pre><code>apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
 name: flux-system
 namespace: flux-system
spec:
 interval: 10m0s
 path: ./cluster/base
 prune: true
 sourceRef:
   kind: GitRepository
   name: flux-system
 validation: client
 decryption:
   provider: sops
   secretRef:
       name: sops-age</code></pre>
<p dir="ltr"><strong>Step 6: Verify and Use</strong></p>
<p dir="ltr">Verify and use the encrypted secrets: Flux will now use SOPS to decrypt the secrets in the Kubernetes cluster.</p>
<p dir="ltr">This setup ensures that your secrets are encrypted and decrypted securely using AGE and SOPS, and Flux can manage these secrets in your GitOps workflow.</p>
<h3 dir="ltr"><strong>SOPS with Text Files</strong>&nbsp;</h3>
<p dir="ltr"><strong>Install SOPS and Age: </strong>Install SOPS and Age on the machine running Flux. You can get the binaries from their GitHub release pages.</p>
<p dir="ltr"><strong>Create a PGP Key:</strong> Generate a PGP key using OpenGPG. Make sure not to specify a passphrase if you plan to use this key with Flux.</p>
<p dir="ltr"><strong>Configure SOPS:</strong> Create a <code>.sops.yaml</code> file in your Git repository to specify the encryption settings. This file defines the rules for encrypting and decrypting files.</p>
<p dir="ltr"><strong>Encrypt Files: </strong>Use the <code>sops</code> command to encrypt your text files. For example, you can encrypt a file <code>secret.yaml</code> using <code>sops -e -i secret.yaml.</code></p>
<p dir="ltr"><strong>Store Encrypted Files:</strong> Store the encrypted files in your Git repository.</p>
<p dir="ltr"><strong>Configure Flux: </strong>Update your Flux Kustomization to use SOPS for decryption. This involves specifying the <code>decryption</code> provider as <code>sops</code> and referencing the secret containing the decryption key.</p>
<p dir="ltr">Flux will automatically decrypt the secrets when reconciling the cluster state. This ensures that the encrypted secrets are decrypted and applied to the cluster only when needed.</p>
<p dir="ltr">By following these steps, you can securely manage and deploy encrypted text files using SOPS and FluxCD.</p>
<h3 dir="ltr"><strong>SOPS with Structured Data</strong></h3>
<p dir="ltr">To use SOPS with structured data using Fluxcd, you can follow these steps:</p>
<p dir="ltr" role="presentation">1. Configure SOPS:</p>
<ul>
<li dir="ltr" role="presentation">Install SOPS and age using their documentation.</li>
<li dir="ltr" role="presentation">Generate a key using <code>age-keygen</code> and create a <code>.sops.yaml</code> file with the public key.</li>
</ul>
<p dir="ltr" role="presentation">2. Encrypt Secrets:</p>
<p dir="ltr">Encrypt your Kubernetes secrets using SOPS. For example, you can encrypt a secret file like this:</p>
<pre><code>apiVersion: v1
kind: Secret
metadata:
 name: mysqlcreds
type: Opaque
data: null
stringData:
 DB_USER: bugs
 DB_PASSWORD: bunny</code></pre>
<p dir="ltr"><strong>Encrypt this file using SOPS:</strong></p>
<pre><code>sops -e mysqlcreds.yaml > mysqlcreds-encrypted.yaml</code></pre>
<p dir="ltr" role="presentation">3. Integrate with Flux:</p>
<p dir="ltr">Configure Flux to use SOPS for decryption. In your <code>gotk-sync.yaml</code> file, add the <code>decryption</code> property:</p>
<pre><code>apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
 name: flux-system
spec:
 interval: 10m0s
 path: ./clusters/my-cluster
 prune: true
 sourceRef:
   kind: GitRepository
   name: flux-system
 decryption:
   provider: sops
   secretRef:
     name: my-private-key</code></pre>
<p dir="ltr">Ensure the secret <code>my-private-key</code> is created correctly and contains the private key.</p>
<p dir="ltr" role="presentation">4. Apply Encrypted Secrets:</p>
<ul>
<li dir="ltr" role="presentation">Push the encrypted secret file to your Git repository.</li>
<li dir="ltr" role="presentation">Flux will pick up the change and reconcile the cluster. The encrypted values should be decrypted and applied correctly.</li>
</ul>
<p dir="ltr">If decryption does not work, check the <code>Flux logs</code> using flux logs to identify any issues.</p>
<p dir="ltr">By following these steps, you can effectively use SOPS with structured data using Fluxcd for secure and automated secret management in your Kubernetes cluster.</p>
<h3 dir="ltr"><strong>SOPS with HashiCorp Vault</strong></h3>
<p dir="ltr">HashiCorp Vault is a secrets manager that provides secure storage and retrieval of secrets. SOPS can be used with HashiCorp Vault for encryption and decryption.</p>
<strong>A Short Introduction to Vault</strong>
<p dir="ltr">HashiCorp Vault is a secrets manager that provides secure storage and retrieval of secrets. It can be used for encryption, decryption, and signing of data. Vault can be used with various backends, including AWS KMS, GCP KMS, and local file systems.</p>
<p dir="ltr">To manage Kubernetes secrets using SOPS with HashiCorp Vault and Flux, follow these steps:</p>
<p dir="ltr" role="presentation">1. Configure HashiCorp Vault:</p>
<ul>
<li dir="ltr" role="presentation">Set up HashiCorp Vault as your identity-based secrets and encryption management system.</li>
<li dir="ltr" role="presentation">Enable the transit backend in Vault to use it for encryption.</li>
</ul>
<p dir="ltr" role="presentation">2. Encrypt Secrets with SOPS: Export the&nbsp;<code>VAULT_ADDR</code> and <code>VAULT_TOKEN</code> environment variables to your shell.</p>
<p dir="ltr">Use <code>sops</code> to encrypt a Kubernetes Secret, specifying the Vault address and token:</p>
<pre><code>sops --hc-vault-transit $VAULT_ADDR/v1/sops/keys/my-encryption-key --encrypt \
--encrypted-regex '^(data|stringData)$' --in-place basic-auth.yaml</code></pre>
<p dir="ltr" role="presentation">3. Create a Secret for the Vault Token: Create a secret for the Vault token using&nbsp;<code>kubectl</code>:</p>
<div dir="ltr" align="left">
<pre><code>echo $VAULT_TOKEN | kubectl create secret generic sops-hcvault \
--namespace=flux-system --from-file=sops.vault-token=/dev/stdin</code></pre>
<p dir="ltr" role="presentation">4. Set Up Flux Kustomization: Set the decryption secret in the Flux Kustomization to&nbsp;<code>sops-hcvault</code>.</p>
<p dir="ltr" role="presentation">5. Authorize Kustomize Controller: Configure the kustomize-controller to use workload identity by adding patches to the flux-system kustomization.yaml file.</p>
<p dir="ltr" role="presentation">6. Integrate with Flux:</p>
<ul>
<li dir="ltr" role="presentation">Flux supports decrypting secrets stored in Flux sources using SOPS without additional controllers.</li>
<li dir="ltr" role="presentation">Flux can synchronize secrets from Vault to a Kubernetes secret using the Vault CSI provider, allowing applications to reference the secret without refactoring.</li>
</ul>
<p dir="ltr">By following these steps, you can securely manage Kubernetes secrets using SOPS with HashiCorp Vault and Flux.</p>
<h3 dir="ltr">Conclusion</h3>
<p dir="ltr">When using cloud services, it is generally recommended to utilize the cloud provider's key management service for better access control and management of encryption keys. For instance, Google Cloud offers Cloud Key Management Service (Cloud KMS), which allows users to create and manage customer-managed encryption keys (CMEKs) for various Google Cloud services and applications. Similarly, Azure provides Azure Key Vault, which supports customer-managed keys (CMKs) and offers different options for storing and managing keys in the cloud.</p>
<p dir="ltr">If the cloud provider does not offer a key management service, alternatives include using Advanced Encryption Standard (AES) encryption or deploying an independent vault. This approach provides full control over encryption keys and can be used in various environments.</p>
<p dir="ltr">Tools like SOPS can be used to manage secrets securely and scalably in a GitOps environment. SOPS supports multiple encryption methods, including AWS KMS, GCP KMS, and HashiCorp Vault, making it highly customizable.</p>
</div>
</div></div> <hr> <div class="d-flex align-items-center flex-wrap"></div> <hr> <div class="article__share mt-0"><ul class="social-list list-inline list--hover blog_social" style="margin: 0 !important; padding: 0 !important"><li class="list-inline-item mr-0"><a href="javascript:void(0)" class="share-network-email"><i class="socicon socicon-google icon icon--xs"></i></a></li> <li class="list-inline-item mr-0"><a href="javascript:void(0)" class="share-network-linkedin"><i class="socicon socicon-linkedin icon icon--xs"></i></a></li> <li class="list-inline-item mr-0"><a href="javascript:void(0)" class="share-network-twitter"><i class="socicon socicon-twitter icon icon--xs"></i></a></li> <li class="list-inline-item mr-0"><a href="javascript:void(0)" class="share-network-facebook"><i class="socicon socicon-facebook icon icon--xs"></i></a></li> <li class="list-inline-item mr-0"><a href="javascript:void(0)" class="share-network-whatsapp"><i class="socicon socicon-whatsapp icon icon--xs"></i></a></li></ul></div></div></div></div></section></div> <footer class="pt-4 pb-0 footer-2 bg--dark" data-v-1a1e3611><div class="container" data-v-1a1e3611><div class="row" data-v-1a1e3611><div class="col-md-3 col-sm-6 col-12 mb-5" data-v-1a1e3611><h3 class="type--uppercase m-0 h6" data-v-1a1e3611>Company</h3> <ul class="list--hover mb-1" data-v-1a1e3611><li data-v-1a1e3611><a href="/about-us/" data-v-1a1e3611>About Us</a></li></ul> <ul class="list--hover d-flex mt-2 icons" data-v-1a1e3611><li data-v-1a1e3611><a href="https://www.facebook.com/profile.php?id=61555276800801" title="Platform Engineers facebook page" target="_blank" data-v-1a1e3611><i class="socicon socicon-facebook icon icon--xs" data-v-1a1e3611></i></a></li> <li class="px-2" data-v-1a1e3611><a href="https://twitter.com/platform_engr" title="Platform Engineers twitter account" target="_blank" data-v-1a1e3611><i class="socicon socicon-twitter icon icon--xs" data-v-1a1e3611></i></a></li> <li class="px-1" data-v-1a1e3611><a href="https://www.linkedin.com/company/platform-engineers/mycompany/" title="Platform Engineers linkedin page" target="_blank" data-v-1a1e3611><i class="socicon socicon-linkedin icon icon--xs" data-v-1a1e3611></i></a></li></ul> <h3 class="type--uppercase m-0 h6" data-v-1a1e3611>Resources</h3> <ul class="list--hover" data-v-1a1e3611><li data-v-1a1e3611><a href="/blog/" data-v-1a1e3611>Blog</a></li> <li data-v-1a1e3611><a href="/case-studies/" data-v-1a1e3611>Case Studies</a></li></ul></div> <div class="col-md-3 col-sm-6 col-12 mb-5" data-v-1a1e3611><h3 class="type--uppercase m-0 h6" data-v-1a1e3611>Services</h3> <ul class="list--hover" data-v-1a1e3611><li data-v-1a1e3611><a href="/services/platform-engineering/" data-v-1a1e3611>Platform Engineering</a></li><li data-v-1a1e3611><a href="/services/kubernetes-consulting-services/" data-v-1a1e3611>Kubernetes Consulting Services</a></li><li data-v-1a1e3611><a href="/services/containerization/" data-v-1a1e3611>Containerization</a></li><li data-v-1a1e3611><a href="/services/performance-optimization/" data-v-1a1e3611>Performance Optimization</a></li><li data-v-1a1e3611><a href="/services/ci-cd-implementation/" data-v-1a1e3611>CI/CD Implementation</a></li><li data-v-1a1e3611><a href="/services/infrastructure-maintenance-and-support/" data-v-1a1e3611>Infra Maintenance &amp; Support</a></li></ul></div> <div class="col-md-3 col-sm-6 col-12 mb-5" data-v-1a1e3611><h3 class="type--uppercase m-0 h6" data-v-1a1e3611>Industries</h3> <ul class="list--hover" data-v-1a1e3611><li data-v-1a1e3611><a href="/industries/IoT/" data-v-1a1e3611>IoT</a></li><li data-v-1a1e3611><a href="/industries/ecommerce/" data-v-1a1e3611>eCommerce</a></li><li data-v-1a1e3611><a href="/industries/fintech/" data-v-1a1e3611>FinTech</a></li><li data-v-1a1e3611><a href="/industries/SaaS/" data-v-1a1e3611>SaaS</a></li><li data-v-1a1e3611><a href="/industries/enterprise/" data-v-1a1e3611>Enterprise</a></li></ul></div> <div class="col-md-3 col-sm-6 col-12 mb-5" data-v-1a1e3611><h3 class="type--uppercase m-0 h6" data-v-1a1e3611>Support</h3> <ul class="list--hover" data-v-1a1e3611><li data-v-1a1e3611><a href="/contact-us/" data-v-1a1e3611>Contact Us</a></li></ul> <h3 class="type--uppercase m-0 h6" data-v-1a1e3611>Assessment</h3> <ul class="list--hover" data-v-1a1e3611><li data-v-1a1e3611><a href="/assessment/" data-v-1a1e3611>Cost Assessment</a></li> <li data-v-1a1e3611><a href="/assessment/" data-v-1a1e3611>Performance Assessment</a></li></ul></div></div></div> <div class="sub-footer mt-3" data-v-1a1e3611><div class="col-md-12 text-center" data-v-1a1e3611><span class="type--fine-print" data-v-1a1e3611>Â© <span class="update-year" data-v-1a1e3611></span> Platform Engineers</span></div></div></footer> <a href="#start" data-scroll-class="100vh:active" title="click &amp; go to top of the page" aria-label="click &amp; go to top of the page" class="back-to-top inner-link"><i class="stack-interface stack-up-open-big"></i></a></div></div></div><script defer src="/_nuxt/static/1737013687/blog/secrets-management-with-gitops-and-sops/state.js"></script><script src="/_nuxt/23217b8.js" defer></script><script src="/_nuxt/1d8d9a4.js" defer></script><script src="/_nuxt/accecf1.js" defer></script><script src="/_nuxt/0f88427.js" defer></script><script src="/_nuxt/990548d.js" defer></script><script src="/_nuxt/b4cbe7a.js" defer></script><script data-n-head="ssr" src="https://www.googletagmanager.com/gtag/js?id=G-LRC7N9VH4L" data-body="true"></script><script data-n-head="ssr" src="/google-tag.js" data-body="true"></script><script data-n-head="ssr" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" data-body="true"></script><script data-n-head="ssr" src="/js/hljs.js" data-body="true"></script>
  </body>
</html>
